<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hello D3</title>
    <script src="d3.js"></script>
    <style>
        svg {
            border: 1px solid #999;
            background: #eee;
        }
        .node circle {
            cursor: pointer;
            stroke: #3182bd;
            stroke-width: 0.5px;
            fill: #c6dbef;
        }

        .node text {
            font: 10px sans-serif;
            pointer-events: none;
            text-anchor: middle;
        }

        line.link {
            fill: none;
        }
    </style>
</head>
<body>


<script>

    var base = 5000;

    // 原始数据
    var nodes = {
        "0": {name: "小二工作台", value: 20000 },
        "1": {name: "功能操作区", value: 15000 },
        "3": {name: "TAB1", value: 12000 },
        "4": {name: "A区", value: 8000 },
        "5": {name: "B区", value: 2000 },
        "6": {name: "C区", value: 500 },
        "7": {name: "D区", value: 1500 },
        "8": {name: "TAB2", value: 1000 },
        "9": {name: "E区", value: 100 },
        "10": {name: "F区", value: 300 },
        "11": {name: "G区", value: 50 },
        "12": {name: "H区", value: 500 },
        "13": {name: "I区", value: 50 },
        "14": {name: "TAB3", value: 3000 },
        "15": {name: "J区", value: 2000 },
        "16": {name: "K区", value: 1000 }
    };
    var links = [
        {source: 0, target: 1, value: 0},
        {source: 1, target: 3, value: 0},
        {source: 3, target: 4, value: 0},
        {source: 3, target: 5, value: 0},
        {source: 3, target: 6, value: 0},
        {source: 3, target: 7, value: 0},
        {source: 1, target: 8, value: 0},
        {source: 8, target: 9, value: 0},
        {source: 8, target: 10, value: 0},
        {source: 8, target: 11, value: 0},
        {source: 8, target: 12, value: 0},
        {source: 8, target: 13, value: 0},
        {source: 1, target: 14, value: 0},
        {source: 14, target: 15, value: 0},
        {source: 14, target: 16, value: 0},
        {source: 15, target: 1, value: 0},
        {source: 16, target: 8, value: 0}
    ]

    // 数据处理
    links.forEach(function(link){
        link.source = nodes[link.source] || {};
        link.target = nodes[link.target] || {};
        // 模拟数据
        link.value = Math.floor(Math.random()*10000+10);
    });
    nodes = d3.values(nodes);
    console.log(links)
    console.log(nodes)

    // 力图初始化
    var width = 800;
    var height = 800;
    var force = d3.layout.force()
        .nodes(nodes) //指定节点数组
        .links(links) //指定连线数组
        .size([width, height]) //指定范围
        .linkDistance(150) //指定连线长度
        .charge([-1000]) //相互之间的作用力
        .start() //开始作用
        .on("tick", function() { //对于每一个时间间隔

            //更新连线坐标
            link.attr("x1", function(d) {
                    return d.source.x;
                })
                .attr("y1", function(d) {
                    return d.source.y;
                })
                .attr("x2", function(d) {
                    return d.target.x;
                })
                .attr("y2", function(d) {
                    return d.target.y;
                });

            node.attr("transform", function(d) {
                return "translate(" + d.x + "," + d.y + ")";
            });
        });

    // 图形创建
    var svg = d3.select("body")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

    //添加连线
    var link = svg.selectAll(".link")
        .data(links);
    link.exit().remove();
    link.enter()
        .insert("line", ".node")
        .attr("class", "link")
        .attr('stroke-width', function(d) {
            return (Math.max(Math.sqrt(d.value) / 10,1)) + 'px';
        })
        .attr('stroke', function(d) {
            var percent = Math.max(1-d.value/base,0);
            var color = Math.floor(Math.min(255*percent,150));
            return 'rgb(255,'+ color +','+ 150 +')';
        })

    //添加节点
    // var color = d3.scale.category20();
    var node = svg.selectAll(".node")
        .data(nodes, function(d) {
            return d.index;
        });
    node.exit().remove();

    var nodeEnter = node.enter().append("g")
        .attr("class", "node")
        .call(force.drag); //使得节点能够拖动
    nodeEnter.append("circle")
        .attr("r", function(d) {
            return Math.max(Math.sqrt(d.value) / 10,5);
        })
    nodeEnter.append("text")
        .attr("dy", "3em")
        .text(function(d) {
            return d.name;
        });
</script>


</body>