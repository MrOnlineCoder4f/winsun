<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hello D3</title>
    <script src="d3.js"></script>
    <style>
        svg {
            border: 1px solid #999;
            background: #eee;
        }
        .node circle {
            cursor: pointer;
            stroke: #3182bd;
            stroke-width: 0.5px;
        }

        .node text {
            font: 10px sans-serif;
            pointer-events: none;
            text-anchor: middle;
        }

        line.link {
            fill: none;
        }
    </style>
</head>
<body>


<script>

    var base = 5000;

    // 原始数据
    var dataset = {
        "name": "小二工作台",
        "count": 20000,
        "children": [{
            "name": "功能操作区",
            "count": 15000,
            "children": [{
                "name": "TAB1",
                "count": 12000,
                "children": [{
                    "name": "A区",
                    "count": 8000
                }, {
                    "name": "B区",
                    "count": 2000
                }, {
                    "name": "C区",
                    "count": 500
                }, {
                    "name": "D区",
                    "count": 1500
                }]
            }, {
                "name": "TAB2",
                "count": 1000,
                "children": [{
                    "name": "E区",
                    "count": 1000
                }, {
                    "name": "F区",
                    "count": 100
                }, {
                    "name": "G区",
                    "count": 500
                }, {
                    "name": "H区",
                    "count": 100
                }, {
                    "name": "I区",
                    "count": 300
                }]
            }, {
                "name": "TAB3",
                "count": 2000,
                "children": [{
                    "name": "G区",
                    "count": 100
                }, {
                    "name": "K区",
                    "count": 1900
                }]
            }]
        }]
    };

    // 数据处理
    var nodes = function() {
        var datas = [],
            i = 0;

        function recurse(node) {
            if (node.children) node.children.forEach(recurse);
            if (!node.id) node.id = ++i;
            datas.push(node);
        }
        recurse(dataset);
        return datas;
    }();
    var links = d3.layout.tree().links(nodes);

    // 力图初始化
    var width = 800;
    var height = 800;
    var force = d3.layout.force()
        .nodes(nodes) //指定节点数组
        .links(links) //指定连线数组
        .size([width, height]) //指定范围
        .linkDistance(150) //指定连线长度
        .charge([-1000]) //相互之间的作用力
        .start() //开始作用
        .on("tick", function() { //对于每一个时间间隔

            //更新连线坐标
            link.attr("x1", function(d) {
                    return d.source.x;
                })
                .attr("y1", function(d) {
                    return d.source.y;
                })
                .attr("x2", function(d) {
                    return d.target.x;
                })
                .attr("y2", function(d) {
                    return d.target.y;
                });

            node.attr("transform", function(d) {
                return "translate(" + d.x + "," + d.y + ")";
            });
        });

    // 图形创建
    var svg = d3.select("body")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

    //添加连线
    var link = svg.selectAll(".link")
        .data(links, function(d) {
            return d.target.id;
        });
    link.exit().remove();
    link.enter().insert("line", ".node")
        .attr("class", "link")
        .attr('stroke-width', function(d) {
            return (Math.max(Math.sqrt(d.target.count) / 10,1)) + 'px';
        })
        .attr('stroke', function(d) {
            var percent = Math.max(1-d.target.count/base,0);
            var color = Math.min(255*percent,150);
            console.log(color)
            return 'rgb(255,'+ color +','+ 150 +')';
        })

    //添加节点
    // var color = d3.scale.category20();
    var node = svg.selectAll(".node")
        .data(nodes, function(d) {
            return d.id;
        });
    node.exit().remove();

    var nodeEnter = node.enter().append("g")
        .attr("class", "node")
        .call(force.drag); //使得节点能够拖动
    nodeEnter.append("circle")
        .attr("r", function(d) {
            return Math.max(Math.sqrt(d.count) / 10,5);
        });
    nodeEnter.append("text")
        .attr("dy", "3em")
        .text(function(d) {
            return d.name;
        });
    node.select("circle")
        .style("fill", function(d) {
            return d.children ? '#fd8d3c':'#c6dbef';
        });
</script>


</body>