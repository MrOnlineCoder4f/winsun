---
layout: default
title: Canvas 粒子效果
---
<style type="text/css">
* {
    padding: 0;
    margin: 0;
    overflow:hidden;
}
canvas{
    background: #eee;
}
</style>
<canvas id="c"></canvas>
<script>
window.requestAnimFrame = window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame || function(callback) {
    window.setTimeout(callback, 1000 / 60);
};
var canvas = document.getElementById('c');
var ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
var settings = {
    'basic': {
        'emission_rate': 50,
        'min_life': 3,
        'life_range': 2,
        'min_angle': 0,
        'angle_range': 360,
        'min_speed': 25,
        'speed_range': 15,
        'min_size': 3,
        'size_range': 2,
        'colour': '#82c4f5'
    }
};
var Particle = function(x, y, angle, speed, life, size) {
    this.pos = {
        x: x || 0,
        y: y || 0
    };
    this.speed = speed || 5;
    this.life = life || 1;
    this.size = size || 2;
    this.lived = 0;
    var radians = angle * Math.PI / 180;
    this.vel = {
        x: Math.cos(radians) * speed,
        y: -Math.sin(radians) * speed
    };
};
var Emitter = function(x, y, settings) {
    this.pos = {
        x: x,
        y: y
    };
    this.settings = settings;
    this.emission_delay = 1000 / settings.emission_rate;
    this.last_update = 0;
    this.last_emission = 0;
    this.particles = [];
};
Emitter.prototype.update = function() {
    if (!this.last_update) {
        this.last_update = Date.now();
        return;
    }
    var time = Date.now();
    var dt = time - this.last_update;
    this.last_emission += dt;
    if (this.last_emission > this.emission_delay) {
        this.last_update = time;
        var i = Math.floor(this.last_emission / this.emission_delay);
        console.log(i)
        this.last_emission -= i * this.emission_delay;
        while (i--) {
            this.particles.push(new Particle(0, 0, this.settings.min_angle + Math.random() * this.settings.angle_range, this.settings.min_speed + Math.random() * this.settings.speed_range, this.settings.min_life + Math.random() * this.settings.life_range, this.settings.min_size + Math.random() * this.settings.size_range));
        }
    }
    dt /= 1000;
    var i = this.particles.length;
    while (i--) {
        var particle = this.particles[i];
        if (particle.dead) {
            this.particles.splice(i, 1);
            continue;
        }
        particle.lived += dt;
        if (particle.lived >= particle.life) {
            particle.dead = true;
            continue;
        }
        particle.pos.x += particle.vel.x * dt;
        particle.pos.y += particle.vel.y * dt;
        ctx.fillStyle = this.settings.colour;
        var x = this.pos.x + particle.pos.x;
        var y = this.pos.y + particle.pos.y;
        ctx.beginPath();
        ctx.arc(x, y, particle.size, 0, Math.PI * 2);
        ctx.fill();
    }
};
var emitter = new Emitter(canvas.width / 2, canvas.height / 2, settings.basic);
var cx = cy = 0;
// document.querySelector('#c').addEventListener('mousemove', function(e) {
//     cx = e.x;
//     cy = e.y;
// });

function loop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    emitter.update();
    requestAnimFrame(loop);
}
loop();
</script>

<!--
<style type="text/css">
* {
    padding: 0;
    margin: 0;
    overflow:hidden;
}
svg{
    background: #eee;
    width: 100%;
    height: 100%;
}
</style>
<svg id="demo">
</svg>
<script>
    var requestAnimFrame =
        window.requestAnimationFrame ||
        window.webkitRequestAnimationFrame ||
        window.mozRequestAnimationFrame ||
        window.oRequestAnimationFrame ||
        window.msRequestAnimationFrame ||
        function(callback){
            return setTimeout(callback,1000/60);
        }

    function Particle(wraper,cfg){
        this.cx = cfg.cx || 0;
        this.cy = cfg.cy || 0;
        this.r = cfg.r || 1;
        this.speed = cfg.speed || 1;
        this.fill = cfg.fill || '#000';
        this.stroke = cfg.stroke || '#f00';
        this.strokeWidth = cfg.strokeWidth || 0;
        this.dead = false;
        this.render(wraper);
    }

    Particle.prototype.render = function(wraper){
        var el = document.createElementNS('http://www.w3.org/2000/svg','circle');
        el.setAttribute('fill',this.fill);
        el.setAttribute('stroke',this.stroke);
        el.setAttribute('stroke-width',this.strokeWidth);
        el.setAttribute('cx',this.cx);
        el.setAttribute('cy',this.cy);
        el.setAttribute('r',this.r);
        this.el = el;
        wraper.appendChild(el);
    }


    function Emitter(){
        this.startTime = Date.now();
        this.particles = [];
    }

    Emitter.prototype.update = function(){
        var demo = document.getElementById('demo');
        this.particles.push(new Particle(demo,{
            cx: demo.offsetWidth*Math.random(),
            cy: 0,
            r: 1+10*Math.random(),
            speed:50
        }));

        var dt = Date.now() - this.startTime;


        var i = this.particles.length;
        while(i--){
            var particle = this.particles[i];
            var cy = particle.cy+dt*particle.speed/1000*Math.random();
            particle.el.setAttribute('cx',particle.cx);
            particle.el.setAttribute('cy',cy);
            if (cy >= demo.offsetHeight) {
                this.particles.splice(i,1);
            };
        }
    }

    var emitter = new Emitter();

    var loop = function(){
        emitter.update();
        requestAnimFrame(loop);
    }
    // loop();
</script>
 -->