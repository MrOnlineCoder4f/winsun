---
layout: default
title:  KISSY组件：图片主色获取脚本rgbaster.js
---

<p>
    说明：图片主色获取脚本rgbaster.js源自开源JS <a href="https://github.com/briangonzalez/rgbaster.js" target="_blank">https://github.com/briangonzalez/rgbaster.js</a>，偶只是把它转换成kissy组件使用哈；
</p>
<div id="demo"></div>

<script type="text/javascript" src="http://g.tbcdn.cn/kissy/k/1.4.4/seed-min.js"></script>
<script type="text/javascript">
    "use strict";
    KISSY.add('gallery/rgbaster/1.0/index',function(){

        // Helper functions.
        var getContext = function(){
            return document.createElement("canvas").getContext('2d');
        };

        var getImageData = function(img, loaded){

            var imgObj = new Image();
            var imgSrc = img.src || img;

            // Can't set cross origin to be anonymous for data url's
            // https://github.com/mrdoob/three.js/issues/1305
            if ( imgSrc.substring(0,5) !== 'data:' )
              imgObj.crossOrigin = "Anonymous";

            imgObj.onload = function(){
              var context = getContext('2d');
              context.drawImage(imgObj, 0, 0);

              var imageData = context.getImageData(0, 0, imgObj.width, imgObj.height);
              loaded && loaded(imageData.data);
            };

            imgObj.src = imgSrc;

        };

        var makeRGB = function(name){
            return ['rgb(', name, ')'].join('');
        };

        var mapPalette = function(palette){
            return palette.map(function(c){ return makeRGB(c.name); });
        };


        // RGBaster Object
        // ---------------
        //
        var BLOCKSIZE = 5;
        var PALETTESIZE = 10;

        var RGBaster = {};

        RGBaster.colors = function(img, opts){

            opts = opts || {};
            var exclude = opts.exclude || [ ], // for example, to exlude white and black:  [ '0,0,0', '255,255,255' ]
                paletteSize = opts.paletteSize || PALETTESIZE;

            getImageData(img, function(data){

                var length        = ( img.width * img.height ) || data.length, 
                    colorCounts   = {}, 
                    rgbString     = '', 
                    rgb           = [], 
                    colors        = {
                        dominant: { name: '', count: 0 }, 
                        palette:  Array.apply(null, new Array(paletteSize)).map(Boolean).map(function(a){ 
                            return { name: '0,0,0', count: 0 }; 
                        }) 
                    };

                // Loop over all pixels, in BLOCKSIZE iterations.
                var i = 0;
                while ( i < length ) {
                    rgb[0] = data[i];
                    rgb[1] = data[i+1];
                    rgb[2] = data[i+2];
                    rgbString = rgb.join(",");

                    // Keep track of counts.
                    if ( rgbString in colorCounts ) {
                        colorCounts[rgbString] = colorCounts[rgbString] + 1;
                    } else {
                        colorCounts[rgbString] = 1;
                    }

                    // Find dominant and palette, ignoring those colors in the exclude list.
                    if ( exclude.indexOf( makeRGB(rgbString) ) === -1 ) {
                        var colorCount = colorCounts[rgbString]; 
                        if ( colorCount > colors.dominant.count ){
                            colors.dominant.name = rgbString; 
                            colors.dominant.count = colorCount; 
                        } else {
                            colors.palette.some(function(c){
                                if ( colorCount > c.count ) {
                                    c.name = rgbString; 
                                    c.count = colorCount; 
                                    return true; 
                                } 
                            }); 
                        }
                    }

                    // Increment!
                    i += BLOCKSIZE * 4;
                }

                if ( opts.success ) {
                    var palette = mapPalette(colors.palette); 
                    opts.success({
                        dominant: makeRGB(colors.dominant.name), 
                        secondary: palette[0], 
                        palette:  palette 
                    });
                }
            });
        };

        return RGBaster;

    });

</script>
<script type="text/javascript">

    KISSY.config({
        packages:[
            {
                name: "gallery/rgbaster/1.0/index",
                path: '/',
                charset: "utf-8",
                ignorePackageNameInUri: true
            }
        ]
    });

    KISSY.use('gallery/rgbaster/1.0/index',function(S,RGBaster){

        var num = Math.floor(Math.random()*2+1);
        var imgurl = '/images/rgb'+num+'.jpg';
        RGBaster.colors(imgurl,{
            paletteSize: 1000,
            exclude: [ 'rgb(255,255,255)', 'rgb(0,0,0)' ],
            success: function(color){
                var demo = document.getElementById('demo');
                var html = '';
                html += '<img src="'+imgurl+'" /><br/>'; 
                html += '主色：<span style="display:inline-block;width:10px;height:10px;border: 1px solid #ccc;background:'+ color.dominant +'"></span><br/>'; 
                html += '辅色：<span style="display:inline-block;width:10px;height:10px;border: 1px solid #ccc;background:'+ color.secondary +'"></span><br/>'; 
                html += '所有颜色：';
                for (var i = 0; i < color.palette.length; i++) {
                    html += '<span style="display:inline-block;width:10px;height:10px;margin:0 5px 5px 0;border: 1px solid #ccc;background:'+ color.palette[i] +'"></span>'; 
                };
                demo.innerHTML = html;
            }
        });

    });

</script>